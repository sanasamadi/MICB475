# setting seed for repeatable data
set.seed(10001)

# load packages
req_packages <- c("MASS", "phyloseq", "ape", "tidyverse", "vegan")
lapply(req_packages, library, character.only = TRUE)

# extracting code for phyloseq object
source("COLOMBIA_final.R")

###### Extracting sample data ########
sampdata <- data.frame(sample_data(COLOMBIA_final))

######## Setting up richness loop ########
# calculate richness metric
estrich <- estimate_richness(COLOMBIA_final)

######## Alpha diversity loop to test each individual predictor ###########
# create new folder for alpha diversity if you want
dir.create("AlphaDiversity")
setwd("AlphaDiversity")

# make vector of column names
allPredictors <- colnames(sampdata)
# make a vector that is just shannon
shannon_vec <- estrich$Shannon

##### alpha diversity loop ######

# make a data frame
results_table_alpha <- data.frame()

for ( x in allPredictors ) {
  # making linear model
  model <- lm(shannon_vec ~ get(x), data = sampdata)
  
  # adjusting p values
  pvalues <- summary(model)$coefficients[,4]
  adjusted_pvalues <- p.adjust(pvalues, method = "BH")
  
  #inserting values in data frame
  new_results <- summary(model)$coefficients |>
    as.data.frame() |> 
    rownames_to_column(var="CoefficientName") |> # this makes the rownames a column
    mutate(predictor = x, adjusted_pvalues) # this tells you which predictor you are using
  results_table_alpha <- rbind(results_table_alpha, new_results)
  
}

# view data frame
results_table_alpha

# removing intercept from table 
results_table_alpha_filt <- results_table_alpha |>
  filter(CoefficientName != "(Intercept)") |> # filters out intercept coefficient
  rowwise() |> 
  mutate(CoefficientName = gsub("get(x)", predictor, CoefficientName, fixed=TRUE)) |> 
  ungroup() 

# view table
results_table_alpha_filt


# open file to save as txt format
write.table(results_table_alpha_filt, file="results_table_alpha.txt", 
            quote = FALSE, sep="\t", row.names = FALSE)

# loop for alpha diversity plots
richness_plots <- list()

for (x in allPredictors) {
  richness_plots[[x]] <- plot_richness(COLOMBIA_final, x = x, measures = c("Shannon")) +
    theme(axis.text.x = element_text(angle = 0, vjust = 0.5, hjust = 0.5))
  
}

richness_plots

# save all plot objects 
for (x in seq_along(allPredictors)) {
  ggsave(filename = paste0("plot_richness_", allPredictors[x], ".png"), 
         plot = richness_plots[[x]], 
         height = 4, width = 6)
 
}

# go back to parent directory if a new directory was made
setwd("..")


#### Beta diversity #####
#create new folder for beta diversity
dir.create("BetaDiversity")
setwd("BetaDiversity")

####### beta diversity loop ########

#### PERMANOVA using bray metric ####
# object for distance matrix
dm_bray <- distance(otu_table(COLOMBIA_final), method = "bray")

# creating data frame to store values
results_table_bray <- data.frame()

# loop
for ( x in allPredictors ) {
  # making linear model
  permanova_results <- adonis2(dm_bray ~ get(x), data = sampdata, permutations = 10000) 
  #inserting values in data frame
  new_results <- permanova_results |>
    as.data.frame() |>
    rownames_to_column(var="CoefficientName") |>
    mutate(predictor = x)
  results_table_bray <- rbind(results_table_bray, new_results)
  
}

# view 
results_table_bray

# removing residual and total from table 
results_table_bray_filt <- results_table_bray |>
  subset(CoefficientName == "get(x)") |> # keeping only predictors
  rowwise() |> 
  mutate(CoefficientName = gsub("get(x)", predictor, CoefficientName, fixed=TRUE)) |> 
  ungroup() 


# view table
results_table_bray_filt

# open file to save
write.table(results_table_bray_filt, file="results_table_bray.txt", 
            quote = FALSE, sep="\t", row.names = FALSE)

#### PERMANOVA using unweighted unifrac metric ####
# object for distance matrix
dm_unifrac <- UniFrac(COLOMBIA_final, weighted = FALSE)

# creating data frame to store values
results_table_unifrac <- data.frame()

### loop ###
for ( x in allPredictors ) {
  
  # making linear model
  permanova_results <- adonis2(dm_unifrac ~ get(x), data = sampdata, permutations = 10000)
  
  #inserting values in data frame
  new_results <- permanova_results |>
    as.data.frame() |>
    rownames_to_column(var="CoefficientName") |>
    mutate(predictor = x)
  results_table_unifrac <- rbind(results_table_unifrac, new_results)
  
}

# view 
results_table_unifrac

# removing residual and total from table 
results_table_unifrac_filt <- results_table_unifrac |>
  subset(CoefficientName == "get(x)") |> 
  rowwise() |> 
  mutate(CoefficientName = gsub("get(x)", predictor, CoefficientName, fixed=TRUE)) |> 
  ungroup() 


# view table
results_table_unifrac_filt

# open file to save
write.table(results_table_bray_filt, file="results_table_unifrac.txt", 
            quote = FALSE, sep="\t", row.names = FALSE)

#!!! loop for beta diversity plots!!!

##### bray plots #####
pcoa_dm_bray <- ordinate(COLOMBIA_final, method = "PCoA", distance = dm_bray)

bray_plots <- list()

for (x in allPredictors) {
  bray_plots[[x]] <- plot_ordination(COLOMBIA_final, pcoa_dm_bray, color = x) +
    labs(title = x)
  
}

bray_plots

# save all plot objects 
for (x in seq_along(allPredictors)) {
  ggsave(filename = paste0("plot_pcoa_bray_", allPredictors[x], ".png"), 
         plot = bray_plots[[x]], 
         height = 4, width = 6)
  
}

##### unifrac plots #####
pcoa_dm_unifrac <- ordinate(COLOMBIA_final, method = "PCoA", distance = dm_unifrac)

unifrac_plots <- list()

for (x in allPredictors) {
  unifrac_plots[[x]] <- plot_ordination(COLOMBIA_final, pcoa_dm_unifrac, color = x) +
    labs(title = x)
  
}

unifrac_plots

# save all plot objects 
for (x in seq_along(allPredictors)) {
  ggsave(filename = paste0("plot_pcoa_unifrac_", allPredictors[x], ".png"), 
         plot = unifrac_plots[[x]], 
         height = 4, width = 6)
  
}

# go back to parent directory if a new directory was made
setwd("..")
