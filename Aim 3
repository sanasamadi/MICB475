library(phyloseq)
library(ape)
library(tidyverse)

# Load data
meta <- read.delim("colombia_metadata.txt")

# Filter data
meta_filtered <- select(meta, BMI, waist_circumference, Body_Fat_Percentage, gender)

# Filter individuals who meet all three criteria or don't meet any of the three
filtered_Individuals <- meta_filtered %>%
  filter((BMI >= 30 & Body_Fat_Percentage >= 25 & waist_circumference >= 90 & gender == "male") |
           (BMI >= 30 & Body_Fat_Percentage >= 30 & waist_circumference >= 80 & gender == "female") |
           (BMI < 30 & Body_Fat_Percentage < 25 & waist_circumference < 90 & gender == "male") |
           (BMI < 30 & Body_Fat_Percentage < 30 & waist_circumference < 80 & gender == "female"))

# Extract the columns with the relevant data
bmi <- filtered_Individuals$BMI
body_fat_percentage <- filtered_Individuals$Body_Fat_Percentage
waist_circumference <- filtered_Individuals$waist_circumference

# Combine the data into a matrix format
data_matrix <- cbind(bmi, body_fat_percentage, waist_circumference)

# Compute the Bray-Curtis dissimilarity matrix using vegan package
bc_dissimilarity <- vegdist(data_matrix, method = "bray")

# Perform PCoA on the dissimilarity matrix
pcoa <- cmdscale(bc_dissimilarity, eig = TRUE, k = 3)

# Extract the PCoA coordinates and add sample IDs
pcoa_df <- data.frame(pcoa$points, Sample_ID = rownames(data_matrix))
colnames(pcoa_df) <- c("PC1", "PC2", "PC3", "Sample_ID")

# Add sample group information to the PCoA coordinates
pcoa_df <- pcoa_df %>% 
  left_join(filtered_Individuals, by = "Sample_ID") %>%
  mutate(Group = ifelse(BMI >= 30 | (Body_Fat_Percentage >= 25 & gender == "male") |
                          (Body_Fat_Percentage >= 30 & gender == "female") |
                          (waist_circumference >= 90 & gender == "male") |
                          (waist_circumference >= 80 & gender == "female"), "Obese", "Non-Obese"))

# Compute the percentage of variance explained by each PC
pcoa_eig <- round(pcoa$eig / sum(pcoa$eig) * 100, 1)

# Plot the PCoA
ggplot(pcoa_df, aes(x = PC1, y = PC2, color = Group, shape = Group)) +
  geom_point(size = 3) +
  labs(title = "PCoA plot based on filtered participant data",
       x = paste0("PC1 (", pcoa_eig[1], "%)"),
       y = paste0("PC2 (", pcoa_eig[2], "%)"),
       color = "Group", shape = "Group") +
  theme_minimal()
