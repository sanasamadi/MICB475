library(phyloseq)
library(ape)
library(tidyverse)

#Load data
meta <- read.delim("colombia_metadata.txt")

#Filter data
meta_filtered <- select(meta, c(BMI, waist_circumference, Body_Fat_Percentage))

# Sample data for demonstration purposes
Individuals <- data.frame(meta_filtered)


# Initialize an empty vector to store the filtered indices
filtered_indices <- c()

# Loop through each row of the data frame
for (i in 1:nrow(Individuals)) {
  row <- Individuals[i,]
  
  # Check if the row meets all three thresholds or if it's below all three thresholds
  if ((row$BMI >= 30 & ((row$gender == "male" & row$Body_Fat_Percentage >= 25) | 
                        (row$gender == "female" & row$Body_Fat_Percentage >= 30)) & 
                        row$waist_circumference >= 90) |
      (row$BMI < 30 & ((row$gender == "male" & row$Body_Fat_Fercentage < 25) | 
                       (row$gender == "female" & row$Body_Fat_Percentage < 30)) & 
                       row$waist_circumference < 90)) {
    filtered_indices <- c(filtered_indices, i)
  }
}

# Subset the data frame to include only the filtered rows
filtered_Individuals <- Individuals[filtered_indices,]

# Read in the filtered participant data (assuming it's stored in a CSV file named "filtered_participants.csv")
filtered_participants <- read.csv("filtered_participants.csv")

# Extract the columns with the relevant data (assuming the columns are named "BMI", "body_fat_percentage", and "waist_circumference")
bmi <- filtered_participants$BMI
body_fat_percentage <- filtered_participants$body_fat_percentage
waist_circumference <- filtered_participants$waist_circumference

# Combine the data into a matrix format
data_matrix <- cbind(bmi, body_fat_percentage, waist_circumference)

# Compute the Bray-Curtis dissimilarity matrix using vegan package
bc_dissimilarity <- vegdist(data_matrix, method = "bray")

# Perform PCoA on the dissimilarity matrix
pcoa <- cmdscale(bc_dissimilarity, eig = TRUE, k = 3)

# Extract the PCoA coordinates and add sample IDs
pcoa_df <- data.frame(pcoa$points, row.names = row.names(data_matrix))
colnames(pcoa_df) <- c("PC1", "PC2", "PC3", "Sample_ID")

# Add sample group information to the PCoA coordinates
pcoa_df <- pcoa_df %>% 
  mutate(Group = ifelse(BMI >= 30 | (body_fat_percentage >= 25 & sex == "male") | (body_fat_percentage >= 30 & sex == "female") | (waist_circumference >= 90 & sex == "male") | (waist_circumference >= 80 & sex == "female"), "Obese", "Non-Obese"))

# Plot the PCoA
ggplot(pcoa_df, aes(x = PC1, y = PC2, color = Group, shape = Group)) +
  geom_point(size = 3) +
  labs(title = "PCoA plot based on filtered participant data",
       x = paste0("PC1 (", round(pcoa_eig[1]*100/sum(pcoa_eig), 1), "%)"),
       y = paste0("PC2 (", round(pcoa_eig[2]*100/sum(pcoa_eig), 1), "%)"),
       color = "Group", shape = "Group") +
  theme_minimal()
