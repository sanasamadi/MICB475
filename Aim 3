library(phyloseq)
library(ape)
library(tidyverse)

# Load data
meta <- read.delim("colombia_metadata.txt")

# Filter data
meta_filtered <- select(meta, c(BMI, waist_circumference, Body_Fat_Percentage, gender))

# Create a new variable for waist circumference threshold based on gender
meta_filtered <- meta_filtered %>% 
  mutate(waist_circumference_threshold = ifelse(gender == "male", 90, 80))

# Filter the data to only include individuals who meet all three criteria or none
Individuals <- meta_filtered %>% 
  mutate(BMI_TF = ifelse(BMI >= 30, 1, 0),
         waist_TF = ifelse(waist_circumference >= waist_circumference_threshold, 1, 0),
         bodyfat_TF = ifelse((gender == "male" & Body_Fat_Percentage >= 25) | 
                               (gender == "female" & Body_Fat_Percentage >= 30), 1, 0)) %>% 
  mutate(number_T = sum(BMI_TF, waist_TF, bodyfat_TF)) %>% 
  filter(number_T == 3 | number_T == 0)

# Filter the columns
bmi <- Individuals$BMI
body_fat_percentage <- Individuals$Body_Fat_Percentage
waist_circumference <- Individuals$waist_circumference

# Make matrix
data_matrix <- cbind(bmi, body_fat_percentage, waist_circumference)

# Compute the Bray-Curtis dissimilarity matrix using vegan package
bc_dissimilarity <- vegdist(data_matrix, method = "bray")

# Perform PCoA on the dissimilarity matrix
pcoa <- cmdscale(bc_dissimilarity, eig = TRUE, k = 3)

# Extract the PCoA coordinates and add sample IDs
pcoa_df <- data.frame(pcoa$points, row.names = row.names(data_matrix))
colnames(pcoa_df) <- c("PC1", "PC2", "PC3", "Sample_ID")

# Add sample group information to the PCoA coordinates
pcoa_df <- pcoa_df %>% 
  mutate(Group = ifelse(BMI >= 30 | (Body_Fat_Percentage >= 25 & gender == "male") | 
                        (Body_Fat_Percentage >= 30 & gender == "female") | 
                        (waist_circumference >= waist_circumference_threshold & gender == "male") | 
                        (waist_circumference >= waist_circumference_threshold & gender == "female"), 
                        "Obese", "Non-Obese"))

# Plot the PCoA
ggplot(pcoa_df, aes(x = PC1, y = PC2, color = Group, shape = Group)) +
  geom_point(size = 3) +
  labs(title = "PCoA plot based on filtered participant data",
       x = paste0("PC1 (", round(pcoa_eig[1]*100/sum(pcoa_eig), 1), "%)"),
       y = paste0("PC2 (", round(pcoa_eig[2]*100/sum(pcoa_eig), 1), "%)"),
       color = "Group", shape = "Group") +
  theme_minimal()
