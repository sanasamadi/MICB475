library(phyloseq)
library(ape)
library(tidyverse)


#Filtering out redundant columns
subset(Data, select = -c(age_range, BMI_class, country))


#### Format OTU table ####
# save everything except first column (OTU ID) into a matrix
otu_mat <- as.matrix(otu[,-1])
# Make first column (#OTU ID) the rownames of the new matrix
rownames(otu_mat) <- otu$`#OTU ID`
# Use the "otu_table" function to make an OTU table
OTU <- otu_table(otu_mat, taxa_are_rows = TRUE) 


#### Format sample metadata ####
# Save everything except sampleid as new data frame
samp_df <- as.data.frame(meta[,-1])
# Make sampleids the rownames
rownames(samp_df)<- meta$sampleid
# Make phyloseq sample data with sample_data() function
SAMP <- sample_data(samp_df)



#### Create phyloseq object ####
# Merge all into a phyloseq object
atacama <- phyloseq(OTU, SAMP)


##How to create additional column for Shannon?


#### Alpha diversity ######

plot_richness(Data, measures = c("Shannon")) 

gg_richness <- plot_richness(atacama_rare, x = "vegetation", measures = c("Shannon","Chao1")) +
  xlab("Vegetation present") +
  geom_boxplot()
gg_richness

ggsave(filename = "Module13/plot_richness.png"
       , gg_richness
       , height=4, width=6)



#### Beta diversity #####
bc_dm <- distance(atacama_rare, method="bray")

pcoa_bc <- ordinate(atacama_rare, method="PCoA", distance=bc_dm)



# Linear Model
ggplot(samp_dat_wdiv,aes(x=averagesoiltemperature, y=Shannon)) +
  geom_point() +
  geom_smooth(method="lm")
