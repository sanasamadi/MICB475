library(phyloseq)
library(ape)
library(tidyverse)


#Load data

#Filtering out redundant columns
meta_filtered <- select(meta, -c(age_range, BMI_class, country))


#### Format OTU table ####
# save everything except first column (OTU ID) into a matrix
otu_mat <- as.matrix(otu[,-1])
# Make first column (#OTU ID) the rownames of the new matrix
rownames(otu_mat) <- otu$`#OTU ID`
# Use the "otu_table" function to make an OTU table
OTU <- otu_table(otu_mat, taxa_are_rows = TRUE) 


#### Format sample metadata ####
# Save everything except sampleid as new data frame
samp_df <- as.data.frame(meta[,-1])
# Make sampleids the rownames
rownames(samp_df)<- meta$sampleid
# Make phyloseq sample data with sample_data() function
SAMP <- sample_data(samp_df)



#### Create phyloseq object ####
# Merge all into a phyloseq object
atacama <- phyloseq(OTU, SAMP)


##How to create additional column for Shannon?
estimate_richness(phyloseqObject, measures = c("Shannon"))



#### Alpha diversity ######

#can make a new folder
dir.create("AlphaDiversity")

#creates vector with just metadata cetrgory names
Y <- colnames(sample_data(phyloseq object)))

#Loop for alpha diversity plots
#Remember to change file paths
for (x in Y) {
plot_richness(phyloseq object, x = x, measures = c("Shannon")) +
  geom_boxplot() +
  ggsave(filename = paste0("Module13/plot_richness_",x,".png")
       , gg_richness
       , height=4, width=6)
       }



#### Beta diversity #####


#can make a new folder
dir.create("BetaDiversity")


bc_dm <- distance(atacama_rare, method="bray")

pcoa_bc <- ordinate(atacama_rare, method="PCoA", distance=bc_dm)



# Linear Model
ggplot(samp_dat_wdiv,aes(x=averagesoiltemperature, y=Shannon)) +
  geom_point() +
  geom_smooth(method="lm")
