# load packages
req_packages <- c("MASS", "phyloseq", "ape", "tidyverse", "vegan")
lapply(req_packages, library, character.only = TRUE)

#Sourcing code from the other file
source("AIC_for_adonis2.R")

#Loading phyloseq object - do we download it as a seperate file first or can we skip this step if it's already in the environment?
load("COLOMBIA_final.R")

# load packages
req_packages <- c("MASS", "phyloseq", "ape", "tidyverse", "vegan")
lapply(req_packages, library, character.only = TRUE)

# sourcing code from the other files
source("AIC_for_adonis2.R")
source("COLOMBIA_final.R")

# extracting sample data from phyloseq object
sampdata <- data.frame(sample_data(COLOMBIA_final))

######## stepAIC for alpha diversity ############

# calculate richness metric
estrich <- estimate_richness(COLOMBIA_final)

# make a vector that is just shannon
shannon_vec <- estrich$Shannon

# make a model with ALL predictors
model_full <- lm(shannon_vec ~ ., data = sampdata)
# using stepAIC from the MASS package:
stepaic_results <- stepAIC(model_full)
stepaic_results # this is the best fit model

# comparing AIC values:
AIC(stepaic_results) # best fit model AIC
AIC(model_full) # full model (all predictors)

######## stepAIC for PERMANOVA ##########

#Rename phyloseq object
phyloseqObject <- COLOMBIA_final

#Extracting sample data of interest
sampdat <- data.frame(sample_data(phyloseqObject))

#Filtering out NAs in the dataset
sampdat_filt <- sampdat %>% select(adiponectin
                                    , age_years
                                    , age_range
                                    , BMI
                                    , BMI_class
                                    , Body_Fat_Percentage
                                    , Calorie_intake
                                    , Cardiometabolic_status
                                    , city
                                    , country
                                    , diastolic_bp
                                    , fiber
                                    , glucose
                                    , Hemoglobin_a1c
                                    , CRP
                                    , insulin
                                    , latitude
                                    , Total_Cholesterol
                                    , HDL
                                    , LDL
                                    , VLDL
                                    , Triglycerides
                                    , medication
                                    , per_carbohydrates
                                    , per_total_protein
                                    , per_total_fat
                                    , per_animal_protein
                                    , per_monoinsaturated_fat
                                    , per_polyunsaturated_fat
                                    , per_saturated_fat
                                    , sex
                                    , smoker
                                    , stool_consistency
                                    , systolic_bp
                                    , MET_mins_per_week
                                    , waist_circumference                        
) %>%
  drop_na(COLOMBIA_final,)
  
  #filtering phyloseq object to remove dropped samples
  phyloseqObject_filt <- prune_samples(rownames(sampdat_filt), phyloseqObject)
  
  #Create a matrix with all the combinations of predictors
  combinations <- expand.grid(rep(list(c(FALSE,TRUE)),ncol(sampdat_filt)))
  combinations <- combinations[-1,]
  
  #Create distance matrix response variable
  dm <- distance(phyloseqObject_filt, method="bray")
  
# Define an empty vector to store the AIC values
aic_results <- vector(length=nrow(combinations))

#Start of loop
for (r in 1:nrow(combinations)) {
  
  # Extract the predictors
  toinclude <- unlist(combinations[r,])
  
  # Select columns from the sample data using the extracted predictors
  newSampDat <- data.frame(sampdat_filt[,toinclude])
  
  # Calculate the distance matrix
  newdm <- distance(phyloseqObject_filt, method="bray", weighted = TRUE, check = TRUE, k = NULL, robust = FALSE, do.upper = TRUE, diag = TRUE)
  
  # Run PERMANOVA on the selected predictors
  permanova_results <- adonis2(newdm ~ ., data=newSampDat, permutations = 10000)
  
  # Calculate AIC value using the custom source codes
  aic <- AICc.PERMANOVA2(permanova_results)
  
  # Save the AIC value into the vector
  aic_results[r] <- aic$AIC
}

# Identify the row with the minimum AIC value
minRow <- which.min(aic_results)

# Extract the predictors for the best model
bestCombo <- unlist(combinations[minRow,])

  #Obtain list of variable of the "best" model
  colnames(data.frame(sampdat_filt[,bestCombo]))
