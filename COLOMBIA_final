# load packages
req_packages <- c("MASS", "phyloseq", "ape", "tidyverse", "vegan")
lapply(req_packages, library, character.only = TRUE)

# load data
otu <- read_tsv("feature-table.txt", skip = 1)
meta <- read_tsv("colombia_metadata.txt")
tax <- read_tsv("taxonomy.tsv")
phylotree <- read.tree("tree.nwk")

# removing redundant columns
select <- dplyr::select
meta_select <- meta |>
  select(-c(age_range, country))
colnames(meta_select)

#### Format OTU table ####
# save everything except first column (OTU ID) into a matrix
otu_mat <- as.matrix(otu[,-1])
# make first column (#OTU ID) the rownames of the new matrix
rownames(otu_mat) <- otu$`#OTU ID`
# use the "otu_table" function to make an OTU table
OTU <- otu_table(otu_mat, taxa_are_rows = TRUE) 


#### Format sample metadata ####
# save everything except sampleid as new data frame
samp_df <- as.data.frame(meta_select[,-1])
# make sampleids the rownames
colnames(meta)
rownames(samp_df)<- meta_select$`#SampleID`
# make phyloseq sample data with sample_data() function
SAMP <- sample_data(samp_df)

#### Formatting taxonomy ####
# convert taxon strings to a table with separate taxa rank columns
colnames(tax)
tax_mat <- tax |>
  separate(col=Taxon, sep="; "
           , into = c("Domain", "Phylum", "Class", 
                      "Order", "Family", "Genus", "Species")) |>
  as.matrix() # Saving as a matrix
# save everything except feature IDS
tax_mat <- tax_mat[,-1]
# make sampleids the rownames
rownames(tax_mat) <- tax$`Feature ID`
# make taxa table
TAX <- tax_table(tax_mat)

#### Create phyloseq object ####
# merge all into a phyloseq object
COLOMBIA <- phyloseq(OTU, SAMP, TAX, phylotree)

# removing mitochondria and chloroplasts
COLOMBIA_filt <- subset_taxa(COLOMBIA, Domain == "d__Bacteria" 
                             & Class!="c__Chloroplast" & Family!="f__Mitochondria")

# removing NA's from systolic bp entry
COLOMBIA_final <- subset_samples(COLOMBIA_filt, !is.na(systolic_bp))
